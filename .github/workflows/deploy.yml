name: Deploy Meeting Bridge

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting Meeting Bridge Deployment..."
          
          # åˆ›å»ºé¡¹ç›®ç›®å½•
          sudo mkdir -p /opt/meeting-bridge
          sudo chown $USER:$USER /opt/meeting-bridge
          cd /opt/meeting-bridge
          
          # å¤åˆ¶é¡¹ç›®æ–‡ä»¶
          cp -r $GITHUB_WORKSPACE/* .
          chmod +x scripts/*.sh
          
          # è¿è¡ŒæœåŠ¡å™¨è®¾ç½®è„šæœ¬
          ./scripts/setup-server.sh
          
          # å¯åŠ¨æœåŠ¡
          docker-compose down
          docker-compose build --no-cache
          docker-compose up -d
          
          echo "âœ… Meeting Bridge deployment completed!"
          echo "ğŸ“Š Services status:"
          docker-compose ps
