name: Deploy Meeting Bridge

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "🚀 Starting Meeting Bridge Deployment..."
          
          # 创建项目目录
          sudo mkdir -p /opt/meeting-bridge
          sudo chown $USER:$USER /opt/meeting-bridge
          cd /opt/meeting-bridge
          
          # 复制项目文件
          cp -r $GITHUB_WORKSPACE/* .
          chmod +x scripts/*.sh
          
          # 运行服务器设置脚本
          ./scripts/setup-server.sh
          
          # 启动服务
          docker-compose down
          docker-compose build --no-cache
          docker-compose up -d
          
          echo "✅ Meeting Bridge deployment completed!"
          echo "📊 Services status:"
          docker-compose ps
